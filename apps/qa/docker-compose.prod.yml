services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://vibeqa:vibeqa@db:5432/vibeqa
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-change-me-in-production-32bytes!}
      - ENV=production
      - CORS_ORIGINS=["http://vibe-qa.152.42.152.243.sslip.io","https://vibe-qa.152.42.152.243.sslip.io"]
    volumes:
      - ./data/artifacts:/app/data/artifacts
    depends_on:
      - db
    restart: unless-stopped
    networks:
      - default
      - coolify

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - default
      - coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vibe-qa.rule=Host(`vibe-qa.152.42.152.243.sslip.io`)"
      - "traefik.http.routers.vibe-qa.entrypoints=http"
      - "traefik.http.services.vibe-qa.loadbalancer.server.port=80"

  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=vibeqa
      - POSTGRES_PASSWORD=vibeqa
      - POSTGRES_DB=vibeqa
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  coolify:
    external: true
