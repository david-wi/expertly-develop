name: Auto-fix Build Failures

on:
  workflow_run:
    workflows: ["Deploy to Production"]
    types: [completed]

jobs:
  auto-fix:
    # Only trigger on failure, NOT on auto-fix branches (prevents infinite loops)
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      !startsWith(github.event.workflow_run.head_branch, 'auto-fix/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Check attempt count (max 3)
        id: attempt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${SHA:0:7}"
          ATTEMPTS=$(gh pr list --search "auto-fix/${SHORT_SHA}" --state all --json number | jq length)
          echo "attempts=$ATTEMPTS" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Current attempt count: $ATTEMPTS"
          if [ "$ATTEMPTS" -ge 3 ]; then
            echo "::error::Max attempts (3) reached for this failure. Human intervention required."
            exit 1
          fi

      - name: Download build logs
        uses: actions/download-artifact@v4
        with:
          name: build-logs
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Analyze and fix with Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ERROR_LOG=""
          if [ -f build.log ]; then
            ERROR_LOG=$(tail -300 build.log)
            echo "Build log found, last 300 lines captured"
          else
            echo "No build.log found, will analyze without specific error"
          fi

          echo "Running Claude Code to analyze and fix..."
          claude --model opus --dangerously-skip-permissions --print "The CI build/deploy workflow failed for the expertly-develop monorepo.

          Error log (last 300 lines):
          \`\`\`
          $ERROR_LOG
          \`\`\`

          Please:
          1. Analyze the error to identify the root cause
          2. Make minimal, targeted fixes to resolve the build failure
          3. Do not make unrelated changes or improvements
          4. Focus only on what's needed to make the build pass

          The monorepo structure:
          - apps/ contains individual applications (define, develop, identity, admin, manage, salon, today, qa, vibecode)
          - packages/ contains shared packages
          - docker-compose.prod.yml defines the production services"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by Claude Code"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --stat
          fi

      - name: Create PR with fix
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: auto-fix build failure [${{ steps.attempt.outputs.short_sha }}]"
          branch: auto-fix/${{ steps.attempt.outputs.short_sha }}-${{ steps.attempt.outputs.attempts }}
          delete-branch: true
          title: "Auto-fix: Build failure from ${{ github.event.workflow_run.head_branch }}"
          body: |
            ## Automated Fix Attempt

            **Original branch**: `${{ github.event.workflow_run.head_branch }}`
            **Failed commit**: `${{ github.event.workflow_run.head_sha }}`
            **Attempt**: ${{ steps.attempt.outputs.attempts }} of 3

            This PR was automatically generated by Claude Code (Opus) to fix a build failure.

            ### Review Checklist
            - [ ] Changes are minimal and targeted
            - [ ] Fix addresses the actual build error
            - [ ] No unintended side effects

            ---
            *Review carefully before merging. If this fix doesn't work, another attempt will be made automatically (up to 3 total).*
          labels: |
            auto-fix
            automated

      - name: No changes needed
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          echo "::warning::Claude Code did not make any changes. The issue may require manual investigation."
          echo "Check the build logs for more context."
