services:
  # ===================
  # EXPERTLY UI (Module Federation Remote)
  # ===================
  ui:
    build:
      context: ./packages/ui
      dockerfile: Dockerfile
      args:
        GIT_COMMIT: ${GIT_COMMIT:-}
        GIT_BRANCH: ${GIT_BRANCH:-main}
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.ui${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.ui${DEPLOY_COLOR:-}.rule=Host(`ui.ai.devintensive.com`)"
      - "traefik.http.routers.ui${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.ui${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.ui${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY DEVELOP
  # ===================
  develop-backend:
    build:
      context: .
      dockerfile: ./apps/develop/backend/Dockerfile
    environment:
      - MONGODB_URL=mongodb://mongo:27017
      - MONGODB_DATABASE=expertly_develop
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DEBUG=false
    depends_on:
      - mongo
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.ed-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.ed-backend${DEPLOY_COLOR:-}.rule=Host(`develop-api.ai.devintensive.com`)"
      - "traefik.http.routers.ed-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.ed-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.ed-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  develop-worker:
    build:
      context: ./apps/develop/backend
      dockerfile: Dockerfile.worker
    environment:
      - MONGODB_URL=mongodb://mongo:27017
      - MONGODB_DATABASE=expertly_develop
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    volumes:
      - artifacts_data:/app/data/artifacts
    depends_on:
      - mongo
    networks:
      - default
    restart: unless-stopped

  develop-frontend:
    build:
      context: .
      dockerfile: ./apps/develop/frontend/Dockerfile
      args:
        VITE_API_URL: https://develop-api.ai.devintensive.com/api/v1
        VITE_BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    depends_on:
      - develop-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.ed-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.ed-frontend${DEPLOY_COLOR:-}.rule=Host(`develop.ai.devintensive.com`)"
      - "traefik.http.routers.ed-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.ed-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.ed-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY ADMIN
  # ===================
  admin-backend:
    build:
      context: .
      dockerfile: ./apps/admin/backend/Dockerfile
    environment:
      - DATABASE_URL=postgresql+asyncpg://admin:admin@admin-db:5432/expertly_admin
      - ENVIRONMENT=production
      - DEBUG=false
    depends_on:
      - admin-db
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.admin-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.admin-backend${DEPLOY_COLOR:-}.rule=Host(`admin-api.ai.devintensive.com`)"
      - "traefik.http.routers.admin-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.admin-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.admin-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  admin-frontend:
    build:
      context: .
      dockerfile: ./apps/admin/frontend/Dockerfile
      args:
        VITE_API_URL: https://admin-api.ai.devintensive.com/api
    depends_on:
      - admin-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.admin-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.admin-frontend${DEPLOY_COLOR:-}.rule=Host(`admin.ai.devintensive.com`)"
      - "traefik.http.routers.admin-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.admin-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.admin-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  admin-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=expertly_admin
    volumes:
      - admin_postgres_data:/var/lib/postgresql/data
    networks:
      - default
    restart: unless-stopped

  # ===================
  # EXPERTLY IDENTITY
  # ===================
  identity-backend:
    build: ./apps/identity/backend
    environment:
      - DATABASE_URL=postgresql+asyncpg://identity:identity@identity-db:5432/identity
      - REDIS_URL=redis://app-redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AUTH_COOKIE_DOMAIN=.ai.devintensive.com
      - SESSION_EXPIRY_DAYS=30
      - SESSION_SECRET=${SESSION_SECRET:-change-me-in-production}
      # Resend email API
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM_ADDRESS=${EMAIL_FROM_ADDRESS:-donotreply@expertly.com}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Expertly}
    volumes:
      - identity_uploads:/app/uploads
    depends_on:
      - identity-db
      - app-redis
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.identity-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.identity-backend${DEPLOY_COLOR:-}.rule=Host(`identity-api.ai.devintensive.com`)"
      - "traefik.http.routers.identity-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.identity-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.identity-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  identity-frontend:
    build:
      context: .
      dockerfile: ./apps/identity/frontend/Dockerfile
      args:
        VITE_API_URL: https://identity-api.ai.devintensive.com/api
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    depends_on:
      - identity-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.identity-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.identity-frontend${DEPLOY_COLOR:-}.rule=Host(`identity.ai.devintensive.com`)"
      - "traefik.http.routers.identity-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.identity-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.identity-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  identity-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=identity
      - POSTGRES_PASSWORD=identity
      - POSTGRES_DB=identity
    volumes:
      - identity_postgres_data:/var/lib/postgresql/data
    networks:
      - default
    restart: unless-stopped

  # ===================
  # EXPERTLY DEFINE
  # ===================
  define-backend:
    build:
      context: .
      dockerfile: ./apps/define/backend/Dockerfile
    environment:
      - SKIP_AUTH=${SKIP_AUTH:-false}
      - LOG_LEVEL=INFO
      - DATABASE_URL=sqlite:///./data/expertly-define.db
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - IDENTITY_API_URL=https://identity-api.ai.devintensive.com
    volumes:
      - define_data:/app/data
      - define_uploads:/app/uploads
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.define-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.define-backend${DEPLOY_COLOR:-}.rule=Host(`define-api.ai.devintensive.com`)"
      - "traefik.http.routers.define-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.define-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.define-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  define-frontend:
    build:
      context: .
      dockerfile: ./apps/define/frontend/Dockerfile.prod
      args:
        VITE_UI_REMOTE_URL: https://ui.ai.devintensive.com
        VITE_IDENTITY_URL: https://identity.ai.devintensive.com
        VITE_BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    depends_on:
      - define-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.define-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.define-frontend${DEPLOY_COLOR:-}.rule=Host(`define.ai.devintensive.com`)"
      - "traefik.http.routers.define-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.define-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.define-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY MANAGE
  # ===================
  manage-backend:
    build:
      context: .
      dockerfile: ./apps/manage/backend/Dockerfile
    environment:
      - MONGODB_URL=mongodb://mongo:27017
      - MONGODB_DATABASE=expertly_manage
    depends_on:
      - mongo
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.manage-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.manage-backend${DEPLOY_COLOR:-}.rule=Host(`manage-api.ai.devintensive.com`)"
      - "traefik.http.routers.manage-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.manage-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.manage-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  manage-frontend:
    build:
      context: .
      dockerfile: ./apps/manage/frontend/Dockerfile
      args:
        VITE_API_URL: ""
    depends_on:
      - manage-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.manage-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.manage-frontend${DEPLOY_COLOR:-}.rule=Host(`manage.ai.devintensive.com`)"
      - "traefik.http.routers.manage-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.manage-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.manage-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY VIBETEST
  # ===================
  vibetest-backend:
    build:
      context: .
      dockerfile: ./apps/vibetest/backend/Dockerfile
    environment:
      - DATABASE_URL=postgresql://vibetest:vibetest@vibetest-db:5432/vibetest
      - SECRET_KEY=${VIBETEST_SECRET_KEY:-super-secret-key-change-in-production}
    depends_on:
      - vibetest-db
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.vibetest-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.vibetest-backend${DEPLOY_COLOR:-}.rule=Host(`vibetest.ai.devintensive.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.vibetest-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.vibetest-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.vibetest-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  vibetest-frontend:
    build:
      context: .
      dockerfile: ./apps/vibetest/frontend/Dockerfile
    depends_on:
      - vibetest-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.vibetest-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.vibetest-frontend${DEPLOY_COLOR:-}.rule=Host(`vibetest.ai.devintensive.com`)"
      - "traefik.http.routers.vibetest-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.vibetest-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.vibetest-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  vibetest-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=vibetest
      - POSTGRES_PASSWORD=vibetest
      - POSTGRES_DB=vibetest
    volumes:
      - vibetest_postgres_data:/var/lib/postgresql/data
    networks:
      - default
    restart: unless-stopped

  # ===================
  # EXPERTLY SALON
  # ===================
  salon-backend:
    build:
      context: .
      dockerfile: ./apps/salon/backend/Dockerfile
    environment:
      - MONGODB_URL=mongodb://mongo:27017
      - MONGODB_DATABASE=expertly_salon
      - JWT_SECRET=${SALON_JWT_SECRET:-super-secret-jwt-key}
    depends_on:
      - mongo
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.salon-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.salon-backend${DEPLOY_COLOR:-}.rule=Host(`salon-api.ai.devintensive.com`)"
      - "traefik.http.routers.salon-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.salon-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.salon-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  salon-frontend:
    build:
      context: .
      dockerfile: ./apps/salon/frontend/Dockerfile
      args:
        VITE_API_URL: https://salon-api.ai.devintensive.com/api/v1
    depends_on:
      - salon-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.salon-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.salon-frontend${DEPLOY_COLOR:-}.rule=Host(`salon.ai.devintensive.com`)"
      - "traefik.http.routers.salon-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.salon-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.salon-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY TODAY
  # ===================
  today-backend:
    build:
      context: .
      dockerfile: ./apps/today/backend/Dockerfile
    environment:
      - DATABASE_URL=postgresql+asyncpg://today:today@today-db:5432/expertly_today
    depends_on:
      - today-db
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.today-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.today-backend${DEPLOY_COLOR:-}.rule=Host(`today-api.ai.devintensive.com`)"
      - "traefik.http.routers.today-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.today-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.today-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  today-frontend:
    build:
      context: .
      dockerfile: ./apps/today/frontend/Dockerfile
      args:
        VITE_API_URL: https://today-api.ai.devintensive.com/api
    depends_on:
      - today-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.today-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.today-frontend${DEPLOY_COLOR:-}.rule=Host(`today.ai.devintensive.com`)"
      - "traefik.http.routers.today-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.today-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.today-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  today-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=today
      - POSTGRES_PASSWORD=today
      - POSTGRES_DB=expertly_today
    volumes:
      - today_postgres_data:/var/lib/postgresql/data
    networks:
      - default
    restart: unless-stopped

  # ===================
  # EXPERTLY VIBECODE
  # ===================
  vibecode:
    build:
      context: .
      dockerfile: ./apps/vibecode/Dockerfile
      target: production
    environment:
      - NODE_ENV=production
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PORT=3001
      - REMOTE_SERVER_URL=${REMOTE_SERVER_URL:-}
      - DEFAULT_EXECUTION_MODE=${DEFAULT_EXECUTION_MODE:-local}
    volumes:
      - ./apps/vibecode/packages/server/downloads:/app/packages/server/downloads
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.vibecode${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.vibecode${DEPLOY_COLOR:-}.rule=Host(`vibecode.ai.devintensive.com`)"
      - "traefik.http.routers.vibecode${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.vibecode${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.vibecode${DEPLOY_COLOR:-}.loadbalancer.server.port=3001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # ===================
  # SHARED DATABASES
  # ===================
  app-redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --protected-mode no
    volumes:
      - redis_data:/data
    networks:
      - default
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  mongo:
    image: mongo:7
    volumes:
      - mongo_data:/data/db
    networks:
      - default
    restart: unless-stopped

networks:
  traefik:
    external: true
  default:
    driver: bridge

volumes:
  admin_postgres_data:
  artifacts_data:
  define_data:
  define_uploads:
  identity_postgres_data:
  identity_uploads:
  mongo_data:
  vibetest_postgres_data:
  redis_data:
  today_postgres_data:
