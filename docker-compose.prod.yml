services:
  # ===================
  # EXPERTLY DEVELOP
  # ===================
  develop-backend:
    build:
      context: .
      dockerfile: ./apps/develop/backend/Dockerfile
    environment:
      - MONGODB_URL=mongodb://expertly-shared-mongo:27017
      - MONGODB_DATABASE=expertly_develop
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DEBUG=false
    networks:
      - traefik
      - default
      - expertly-shared
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.ed-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.ed-backend${DEPLOY_COLOR:-}.rule=Host(`develop-api.ai.devintensive.com`)"
      - "traefik.http.routers.ed-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.ed-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.ed-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  develop-worker:
    build:
      context: ./apps/develop/backend
      dockerfile: Dockerfile.worker
    environment:
      - MONGODB_URL=mongodb://expertly-shared-mongo:27017
      - MONGODB_DATABASE=expertly_develop
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    volumes:
      - artifacts_data:/app/data/artifacts
    networks:
      - default
      - expertly-shared
    restart: unless-stopped

  develop-frontend:
    build:
      context: .
      dockerfile: ./apps/develop/frontend/Dockerfile
      args:
        VITE_API_URL: https://develop-api.ai.devintensive.com/api/v1
        VITE_BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    depends_on:
      - develop-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.ed-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.ed-frontend${DEPLOY_COLOR:-}.rule=Host(`develop.ai.devintensive.com`)"
      - "traefik.http.routers.ed-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.ed-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.ed-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY ADMIN
  # ===================
  admin-backend:
    build:
      context: .
      dockerfile: ./apps/admin/backend/Dockerfile
    environment:
      - DATABASE_URL=postgresql+asyncpg://${DO_PG_USER:-doadmin}:${DO_PG_PASSWORD}@${DO_PG_HOST}:${DO_PG_PORT:-25060}/expertly_admin?ssl=require
      - ENVIRONMENT=production
      - DEBUG=false
    volumes:
      - ./config:/app/config:ro
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.admin-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.admin-backend${DEPLOY_COLOR:-}.rule=Host(`admin-api.ai.devintensive.com`)"
      - "traefik.http.routers.admin-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.admin-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.admin-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  admin-frontend:
    build:
      context: .
      dockerfile: ./apps/admin/frontend/Dockerfile
      args:
        VITE_API_URL: https://admin-api.ai.devintensive.com/api
        BUILD_VERSION: ${GIT_COMMIT:-unknown}
    depends_on:
      - admin-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.admin-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.admin-frontend${DEPLOY_COLOR:-}.rule=Host(`admin.ai.devintensive.com`)"
      - "traefik.http.routers.admin-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.admin-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.admin-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY IDENTITY
  # ===================
  identity-backend:
    build: ./apps/identity/backend
    environment:
      - DATABASE_URL=postgresql+asyncpg://${DO_PG_USER:-doadmin}:${DO_PG_PASSWORD}@${DO_PG_HOST}:${DO_PG_PORT:-25060}/expertly_identity?ssl=require
      - REDIS_URL=redis://expertly-shared-redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AUTH_COOKIE_DOMAIN=.ai.devintensive.com
      - SESSION_EXPIRY_DAYS=30
      - SESSION_SECRET=${SESSION_SECRET:-change-me-in-production}
      # Resend email API
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM_ADDRESS=${EMAIL_FROM_ADDRESS:-donotreply@expertly.com}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-Expertly}
      - ADMIN_API_URL=https://admin-api.ai.devintensive.com
      # Deepgram for voice transcription
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY:-}
    networks:
      - traefik
      - default
      - expertly-shared
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.identity-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.identity-backend${DEPLOY_COLOR:-}.rule=Host(`identity-api.ai.devintensive.com`)"
      - "traefik.http.routers.identity-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.identity-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.identity-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  identity-frontend:
    build:
      context: .
      dockerfile: ./apps/identity/frontend/Dockerfile
      args:
        VITE_API_URL: https://identity-api.ai.devintensive.com/api
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    depends_on:
      - identity-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.identity-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.identity-frontend${DEPLOY_COLOR:-}.rule=Host(`identity.ai.devintensive.com`)"
      - "traefik.http.routers.identity-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.identity-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.identity-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY DEFINE
  # ===================
  define-backend:
    build:
      context: .
      dockerfile: ./apps/define/backend/Dockerfile
    environment:
      - SKIP_AUTH=${SKIP_AUTH:-false}
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql+asyncpg://${DO_PG_USER:-doadmin}:${DO_PG_PASSWORD}@${DO_PG_HOST}:${DO_PG_PORT:-25060}/expertly_define?ssl=require
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - IDENTITY_API_URL=https://identity-api.ai.devintensive.com
      - ADMIN_API_URL=https://admin-api.ai.devintensive.com
    volumes:
      - define_uploads:/app/uploads
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.define-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.define-backend${DEPLOY_COLOR:-}.rule=Host(`define-api.ai.devintensive.com`)"
      - "traefik.http.routers.define-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.define-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.define-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  define-frontend:
    build:
      context: .
      dockerfile: ./apps/define/frontend/Dockerfile.prod
      args:
        VITE_IDENTITY_URL: https://identity.ai.devintensive.com
        VITE_BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    depends_on:
      - define-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.define-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.define-frontend${DEPLOY_COLOR:-}.rule=Host(`define.ai.devintensive.com`)"
      - "traefik.http.routers.define-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.define-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.define-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY COMMAND
  # ===================
  command-backend:
    build:
      context: .
      dockerfile: ./apps/command/backend/Dockerfile
    volumes:
      - command_avatars:/app/uploads/avatars
    environment:
      - MONGODB_URL=mongodb://expertly-shared-mongo:27017
      - MONGODB_DATABASE=expertly_manage
      # OAuth Connections (optional - connections feature requires these)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - SLACK_CLIENT_ID=${SLACK_CLIENT_ID:-}
      - SLACK_CLIENT_SECRET=${SLACK_CLIENT_SECRET:-}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET:-}
      - CONNECTION_ENCRYPTION_KEY=${CONNECTION_ENCRYPTION_KEY:-}
      # AI features (uses Groq via Admin AI Config)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY:-}
      - ADMIN_API_URL=https://admin-api.ai.devintensive.com
    networks:
      - traefik
      - default
      - expertly-shared
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.command-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.command-backend${DEPLOY_COLOR:-}.rule=Host(`command-api.ai.devintensive.com`)"
      - "traefik.http.routers.command-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.command-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.command-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
      # Redirect old manage-api URLs to command-api
      - "traefik.http.routers.manage-api-redirect${DEPLOY_COLOR:-}.rule=Host(`manage-api.ai.devintensive.com`)"
      - "traefik.http.routers.manage-api-redirect${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.manage-api-redirect${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.manage-api-redirect${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.routers.manage-api-redirect${DEPLOY_COLOR:-}.middlewares=manage-api-to-command-redirect${DEPLOY_COLOR:-}"
      - "traefik.http.middlewares.manage-api-to-command-redirect${DEPLOY_COLOR:-}.redirectregex.regex=^https://manage-api\\.ai\\.devintensive\\.com(.*)"
      - "traefik.http.middlewares.manage-api-to-command-redirect${DEPLOY_COLOR:-}.redirectregex.replacement=https://command-api.ai.devintensive.com$${1}"
      - "traefik.http.middlewares.manage-api-to-command-redirect${DEPLOY_COLOR:-}.redirectregex.permanent=true"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  command-frontend:
    build:
      context: .
      dockerfile: ./apps/command/frontend/Dockerfile
      args:
        VITE_API_URL: ""
    depends_on:
      - command-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.command-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.command-frontend${DEPLOY_COLOR:-}.rule=Host(`command.ai.devintensive.com`)"
      - "traefik.http.routers.command-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.command-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.command-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
      # Redirect old manage URLs to command
      - "traefik.http.routers.manage-redirect${DEPLOY_COLOR:-}.rule=Host(`manage.ai.devintensive.com`)"
      - "traefik.http.routers.manage-redirect${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.manage-redirect${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.manage-redirect${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.routers.manage-redirect${DEPLOY_COLOR:-}.middlewares=manage-to-command-redirect${DEPLOY_COLOR:-}"
      - "traefik.http.middlewares.manage-to-command-redirect${DEPLOY_COLOR:-}.redirectregex.regex=^https://manage\\.ai\\.devintensive\\.com(.*)"
      - "traefik.http.middlewares.manage-to-command-redirect${DEPLOY_COLOR:-}.redirectregex.replacement=https://command.ai.devintensive.com$${1}"
      - "traefik.http.middlewares.manage-to-command-redirect${DEPLOY_COLOR:-}.redirectregex.permanent=true"
    restart: unless-stopped

  # ===================
  # EXPERTLY VIBETEST
  # ===================
  vibetest-backend:
    build:
      context: .
      dockerfile: ./apps/vibetest/backend/Dockerfile
    environment:
      - DATABASE_URL=postgresql+asyncpg://${DO_PG_USER:-doadmin}:${DO_PG_PASSWORD}@${DO_PG_HOST}:${DO_PG_PORT:-25060}/vibeqa?ssl=require
      - SECRET_KEY=${VIBETEST_SECRET_KEY:-super-secret-key-change-in-production}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ADMIN_API_URL=https://admin-api.ai.devintensive.com
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.vibetest-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.vibetest-backend${DEPLOY_COLOR:-}.rule=Host(`vibetest.ai.devintensive.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.vibetest-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.vibetest-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.vibetest-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  vibetest-frontend:
    build:
      context: .
      dockerfile: ./apps/vibetest/frontend/Dockerfile
    depends_on:
      - vibetest-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.vibetest-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.vibetest-frontend${DEPLOY_COLOR:-}.rule=Host(`vibetest.ai.devintensive.com`)"
      - "traefik.http.routers.vibetest-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.vibetest-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.vibetest-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY SALON
  # ===================
  salon-backend:
    build:
      context: .
      dockerfile: ./apps/salon/backend/Dockerfile
    environment:
      - MONGODB_URL=mongodb://expertly-shared-mongo:27017
      - MONGODB_DATABASE=expertly_salon
      - JWT_SECRET=${SALON_JWT_SECRET:-super-secret-jwt-key}
    networks:
      - traefik
      - default
      - expertly-shared
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.salon-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.salon-backend${DEPLOY_COLOR:-}.rule=Host(`salon-api.ai.devintensive.com`)"
      - "traefik.http.routers.salon-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.salon-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.salon-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  salon-frontend:
    build:
      context: .
      dockerfile: ./apps/salon/frontend/Dockerfile
      args:
        VITE_API_URL: https://salon-api.ai.devintensive.com/api/v1
    depends_on:
      - salon-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.salon-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.salon-frontend${DEPLOY_COLOR:-}.rule=Host(`salon.ai.devintensive.com`)"
      - "traefik.http.routers.salon-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.salon-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.salon-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY TODAY
  # ===================
  today-backend:
    build:
      context: .
      dockerfile: ./apps/today/backend/Dockerfile
    environment:
      - DATABASE_URL=postgresql+asyncpg://${DO_PG_USER:-doadmin}:${DO_PG_PASSWORD}@${DO_PG_HOST}:${DO_PG_PORT:-25060}/expertly_today?ssl=require
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.today-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.today-backend${DEPLOY_COLOR:-}.rule=Host(`today-api.ai.devintensive.com`)"
      - "traefik.http.routers.today-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.today-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.today-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  today-frontend:
    build:
      context: .
      dockerfile: ./apps/today/frontend/Dockerfile
      args:
        VITE_API_URL: https://today-api.ai.devintensive.com/api
    depends_on:
      - today-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.today-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.today-frontend${DEPLOY_COLOR:-}.rule=Host(`today.ai.devintensive.com`)"
      - "traefik.http.routers.today-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.today-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.today-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY TMS
  # ===================
  tms-backend:
    build:
      context: .
      dockerfile: ./apps/tms/backend/Dockerfile
    environment:
      - MONGODB_URL=mongodb://expertly-shared-mongo:27017
      - MONGODB_DATABASE=expertly_tms
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    networks:
      - traefik
      - default
      - expertly-shared
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.tms-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.tms-backend${DEPLOY_COLOR:-}.rule=Host(`tms-api.ai.devintensive.com`)"
      - "traefik.http.routers.tms-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.tms-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.tms-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  tms-frontend:
    build:
      context: .
      dockerfile: ./apps/tms/frontend/Dockerfile
      args:
        VITE_API_URL: https://tms-api.ai.devintensive.com/api/v1
    depends_on:
      - tms-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.tms-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.tms-frontend${DEPLOY_COLOR:-}.rule=Host(`tms.ai.devintensive.com`)"
      - "traefik.http.routers.tms-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.tms-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.tms-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY DISCOVER (Landing Page)
  # ===================
  discover-frontend:
    build:
      context: .
      dockerfile: ./apps/discover/frontend/Dockerfile
      args:
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.discover-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.discover-frontend${DEPLOY_COLOR:-}.rule=Host(`discover.ai.devintensive.com`)"
      - "traefik.http.routers.discover-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.discover-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.discover-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY HEAR (Landing Page)
  # ===================
  hear-frontend:
    build:
      context: .
      dockerfile: ./apps/hear/frontend/Dockerfile
      args:
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.hear-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.hear-frontend${DEPLOY_COLOR:-}.rule=Host(`hear.ai.devintensive.com`)"
      - "traefik.http.routers.hear-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.hear-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.hear-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY COWORK (Landing Page)
  # ===================
  cowork-frontend:
    build:
      context: .
      dockerfile: ./apps/cowork/frontend/Dockerfile
      args:
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.cowork-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.cowork-frontend${DEPLOY_COLOR:-}.rule=Host(`cowork.ai.devintensive.com`)"
      - "traefik.http.routers.cowork-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.cowork-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.cowork-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # AIPOCALYPSE FUND
  # ===================
  aipocalypse-backend:
    build:
      context: .
      dockerfile: ./apps/aipocalypse/backend/Dockerfile
    environment:
      - MONGODB_URL=mongodb://expertly-shared-mongo:27017
      - MONGODB_DATABASE=aipocalypse_fund
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    networks:
      - traefik
      - default
      - expertly-shared
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.aipocalypse-backend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.aipocalypse-backend${DEPLOY_COLOR:-}.rule=Host(`aipocalypse-api.ai.devintensive.com`)"
      - "traefik.http.routers.aipocalypse-backend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.aipocalypse-backend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.aipocalypse-backend${DEPLOY_COLOR:-}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  aipocalypse-frontend:
    build:
      context: .
      dockerfile: ./apps/aipocalypse/frontend/Dockerfile
      args:
        VITE_BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        VITE_GIT_COMMIT: ${GIT_COMMIT:-}
    depends_on:
      - aipocalypse-backend
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.aipocalypse-frontend${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.aipocalypse-frontend${DEPLOY_COLOR:-}.rule=Host(`aipocalypse.ai.devintensive.com`)"
      - "traefik.http.routers.aipocalypse-frontend${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.aipocalypse-frontend${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.aipocalypse-frontend${DEPLOY_COLOR:-}.loadbalancer.server.port=80"
    restart: unless-stopped

  # ===================
  # EXPERTLY VIBECODE
  # ===================
  vibecode:
    build:
      context: .
      dockerfile: ./apps/vibecode/Dockerfile
      target: production
    environment:
      - NODE_ENV=production
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PORT=3001
      - REMOTE_SERVER_URL=${REMOTE_SERVER_URL:-}
      - DEFAULT_EXECUTION_MODE=${DEFAULT_EXECUTION_MODE:-local}
      - ADMIN_API_URL=https://admin-api.ai.devintensive.com
    volumes:
      - ./apps/vibecode/packages/server/downloads:/app/packages/server/downloads
    networks:
      - traefik
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.vibecode${DEPLOY_COLOR:-}.entrypoints=https"
      - "traefik.http.routers.vibecode${DEPLOY_COLOR:-}.rule=Host(`vibecode.ai.devintensive.com`)"
      - "traefik.http.routers.vibecode${DEPLOY_COLOR:-}.tls=true"
      - "traefik.http.routers.vibecode${DEPLOY_COLOR:-}.tls.certresolver=letsencrypt"
      - "traefik.http.services.vibecode${DEPLOY_COLOR:-}.loadbalancer.server.port=3001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # ===================
  # SHARED DATABASES
  # ===================
  # MongoDB and Redis are now in docker-compose.shared.yml
  # They run on the expertly-shared network, independent of blue-green deployments
  # Start shared services with: docker compose -f docker-compose.shared.yml up -d

networks:
  traefik:
    external: true
  default:
    driver: bridge
  # Shared network for databases that persist across blue-green deployments
  expertly-shared:
    external: true
    name: expertly-shared

volumes:
  artifacts_data:
  # Shared volumes - external to prevent blue/green prefixing
  # These persist across deployments so data survives blue-green switches
  define_uploads:
    external: true
    name: shared_define_uploads
  command_avatars:
    external: true
    name: shared_command_avatars
