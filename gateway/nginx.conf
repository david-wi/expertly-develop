events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    upstream develop_frontend {
        server develop-frontend:80;
    }

    upstream develop_backend {
        server develop-backend:8000;
    }

    upstream define_app {
        server define:3000;
    }

    upstream manage_frontend {
        server manage-frontend:80;
    }

    upstream manage_backend {
        server manage-backend:8000;
    }

    upstream qa_frontend {
        server qa-frontend:80;
    }

    upstream qa_backend {
        server qa-backend:8000;
    }

    upstream salon_frontend {
        server salon-frontend:80;
    }

    upstream salon_backend {
        server salon-backend:8000;
    }

    upstream today_frontend {
        server today-frontend:80;
    }

    upstream today_backend {
        server today-backend:8000;
    }

    server {
        listen 80;
        server_name _;

        # Root redirects to develop by default
        location = / {
            return 302 /develop/;
        }

        # === DEVELOP ===
        location /develop/api/ {
            rewrite ^/develop/api/(.*)$ /api/$1 break;
            proxy_pass http://develop_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /develop/ {
            rewrite ^/develop/(.*)$ /$1 break;
            proxy_pass http://develop_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /develop {
            return 302 /develop/;
        }

        # === DEFINE ===
        location /define/api/ {
            rewrite ^/define/api/(.*)$ /api/$1 break;
            proxy_pass http://define_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /define/ {
            rewrite ^/define/(.*)$ /$1 break;
            proxy_pass http://define_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /define {
            return 302 /define/;
        }

        # === MANAGE ===
        location /manage/api/ {
            rewrite ^/manage/api/(.*)$ /api/$1 break;
            proxy_pass http://manage_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /manage/ {
            rewrite ^/manage/(.*)$ /$1 break;
            proxy_pass http://manage_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /manage {
            return 302 /manage/;
        }

        # === QA ===
        location /qa/api/ {
            rewrite ^/qa/api/(.*)$ /api/$1 break;
            proxy_pass http://qa_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /qa/ {
            rewrite ^/qa/(.*)$ /$1 break;
            proxy_pass http://qa_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /qa {
            return 302 /qa/;
        }

        # === SALON ===
        location /salon/api/ {
            rewrite ^/salon/api/(.*)$ /api/$1 break;
            proxy_pass http://salon_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /salon/ {
            rewrite ^/salon/(.*)$ /$1 break;
            proxy_pass http://salon_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /salon {
            return 302 /salon/;
        }

        # === TODAY ===
        location /today/api/ {
            rewrite ^/today/api/(.*)$ /api/$1 break;
            proxy_pass http://today_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /today/ {
            rewrite ^/today/(.*)$ /$1 break;
            proxy_pass http://today_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /today {
            return 302 /today/;
        }
    }
}
